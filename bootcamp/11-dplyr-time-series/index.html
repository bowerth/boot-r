<!DOCTYPE html>
<html>
  <head>
    <title>dplyr Time Series Manipulation</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# dplyr Time Series Manipulation
## Calculate Growth Rates and Ratios
### 2017/12/11

---

class: inverse, center, middle

# Calculating Ratios using dplyr





---

## 6A. Value added and its components by activity, ISIC rev4

- http://stats.oecd.org/Index.aspx?DataSetCode=SNA_TABLE6A
- Location: OECD Countries
- Transaction: VA (B1GA), Output (P1), Intermediate Cons (P2)
- Activity: 21 Sections ISIC Rev. 4 and Total Economy
- Measure: Current prices, Constant Prices (National Base Year)
- Time: 2000-2016
- Value: National Currency (Mio.)


```r
sna_dat &lt;- read.csv("../data/sna_table6a.csv")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; LOCATION &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; TRANSACT &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; ACTIVITY &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; MEASURE &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; TIME &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Value &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 644959 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2001 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 690375 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2002 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 731107 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2003 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 786958 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 847314 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2005 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 919054 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2006 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1002660 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2007 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1088972 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2008 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1175982 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2009 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1207173 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

### Create subset with total economy data

Could be any other data set with harmonized dimensions

- rename value column to avoid automatic joining on common names


```r
sna_dat_tot &lt;-
  sna_dat %&gt;% filter(ACTIVITY == "VTOT") %&gt;%
  mutate(value_total = Value) %&gt;%
  select(LOCATION, TRANSACT, MEASURE, TIME, value_total)
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; LOCATION &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; TRANSACT &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; MEASURE &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; TIME &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; value_total &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 644959 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2001 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 690375 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2002 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 731107 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2003 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 786958 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 847314 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2005 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 919054 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2006 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1002660 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2007 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1088972 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2008 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1175982 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2009 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1207173 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

### Calculate activities' share in total economy

- join on common columns (here specified explicitly)
- calculate ratio using two numeric columns (check reusult for `Inf` and `NA`)


```r
sna_dat_share &lt;- sna_dat %&gt;%
  left_join(sna_dat_tot, by = c("LOCATION", "TRANSACT", "MEASURE", "TIME")) %&gt;%
  mutate(share = Value / value_total,
         share_pct = share * 100)
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; LOCATION &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; TRANSACT &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; ACTIVITY &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; MEASURE &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; TIME &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Value &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; value_total &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; share &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; share_pct &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 38908.35 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 190624.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.204 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20.4 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2001 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 40446.71 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 197076.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.205 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20.5 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2002 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 40192.86 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 202353.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.199 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19.9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2003 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 40467.36 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 207247.7 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.195 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19.5 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 42014.61 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 216098.3 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.194 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19.4 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2005 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 44228.92 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 225888.1 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.196 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19.6 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2006 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 47735.52 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 239076.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.200 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20.0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2007 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 51552.36 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 253604.7 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.203 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20.3 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2008 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 51165.88 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 262414.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.195 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 19.5 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2009 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 47129.75 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 256671.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.184 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 18.4 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

### Plot activities' share in total economy (selected countries)


```r
sna_dat_share %&gt;%
  filter(LOCATION%in%c("AUT","BEL") &amp; ACTIVITY!="VTOT" &amp; MEASURE=="C") %&gt;%
  ggplot(aes(x = TIME, y = share, color = ACTIVITY)) + geom_line() +
  facet_grid(Country ~ Transaction) + scale_color_discrete(guide = guide_legend(ncol = 2))
```

![](11-dplyr-time-series/fig-html/data_plot_sna-1.svg)&lt;!-- --&gt;

---
class: inverse, center, middle

# Ratio example: Top 3 activities by country in 2016

---

### Ratio example: Top 3 activities by country in 2016


```r
sna_dat_share_b1ga_2016_top3 &lt;- sna_dat_share %&gt;%
  filter(ACTIVITY != "VTOT", TRANSACT == "B1GA", MEASURE == "C", TIME == "2016") %&gt;%
  group_by(LOCATION) %&gt;%
  top_n(3, wt = share)
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; LOCATION &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; TRANSACT &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; MEASURE &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; TIME &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; ACTIVITY &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Value &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; value_total &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; share &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 57258.75 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 314692.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.18 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VG &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 38405.87 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 314692.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.12 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VL &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 30999.79 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 314692.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.10 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; BEL &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 53858.70 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 377635.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.14 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; BEL &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VG &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 46028.20 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 377635.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.12 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; BEL &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VM &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 36101.20 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 377635.6 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.10 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; CHE &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 117303.76 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 638981.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.18 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; CHE &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VG &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 91272.66 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 638981.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.14 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; CHE &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VO &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 68343.49 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 638981.4 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.11 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; CZE &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VC &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1162392.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4292397.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.27 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; CZE &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VG &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 471827.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4292397.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.11 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; CZE &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2016 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VL &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 360797.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 4292397.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.08 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

### Ratio example: Top 3 activities by country in 2016


```r
sna_dat_share_b1ga_2016_top3 %&gt;%
  mutate(act_label = paste(ACTIVITY, Activity)) %&gt;%
  ggplot(aes(x = LOCATION, y = share, fill = act_label)) +
  geom_bar(stat = "identity", position = "stack", width = 0.6) +
  scale_fill_discrete(guide = guide_legend(nrow = 3)) +
  theme(legend.position = "top", legend.direction = "horizontal")
```

![](11-dplyr-time-series/fig-html/plot_top_sna-1.svg)&lt;!-- --&gt;

---
class: inverse, center, middle

# Calculating Growth Rates using dplyr

---

### The `lag` function

- Time dimension must be in `date` format "`yyyy-mm-dd`"


```r
sna_dat2 &lt;- sna_dat %&gt;% mutate(date = as.Date(paste0(TIME, "-01-01")))
head(sna_dat2$date, 5)
```

```
## [1] "2000-01-01" "2001-01-01" "2002-01-01" "2003-01-01" "2004-01-01"
```

```r
class(sna_dat2$date)
```

```
## [1] "Date"
```

```r
dplyr::lag(head(sna_dat2$date, 5))
```

```
## [1] NA           "2000-01-01" "2001-01-01" "2002-01-01" "2003-01-01"
```

```r
stats::lag(head(sna_dat2$date, 5))
```

```
## [1] "2000-01-01" "2001-01-01" "2002-01-01" "2003-01-01" "2004-01-01"
```

```r
## ?lag
```

---

### Calculate Growth Rate


```r
sna_growth &lt;- sna_dat2 %&gt;%
  group_by(LOCATION, TRANSACT, ACTIVITY, MEASURE) %&gt;%
  mutate(value_lag = lag(Value),
         growth = Value / value_lag - 1)
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; LOCATION &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; TRANSACT &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; ACTIVITY &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; MEASURE &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; TIME &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Value &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; value_lag &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; growth &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2000 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 644959 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2001 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 690375 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 644959 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.070 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2002 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 731107 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 690375 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.059 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2003 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 786958 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 731107 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.076 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 847314 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 786958 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.077 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2005 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 919054 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 847314 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.085 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2006 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1002660 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 919054 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.091 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2007 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1088972 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1002660 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.086 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2008 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1175982 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1088972 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.080 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; AUS &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2009 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1207173 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1175982 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.027 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---
class: inverse, center, middle

# Growth rate example: countries with maximum absolute growth rates

---

### Countries with maximum absolute growth rates


```r
sna_growth_top &lt;- sna_growth %&gt;%
  filter(ACTIVITY == "VTOT" &amp; TRANSACT == "B1GA") %&gt;%
  group_by(LOCATION) %&gt;%
  top_n(n = 1, wt = abs(growth)) %&gt;%
  arrange(desc(growth))
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; LOCATION &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; TRANSACT &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; ACTIVITY &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; MEASURE &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; TIME &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Value &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; value_lag &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; growth &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; TUR &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2002 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 317199.87 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 218880.94 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.449 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; IRL &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2015 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 236813.52 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 177538.93 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.334 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; LVA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2007 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 20069.82 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 15130.98 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.326 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; EST &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2007 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 14258.48 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11888.96 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.199 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; ISL &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2008 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1356808.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1152608.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.177 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; HUN &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2001 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 13335190.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 11395842.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.170 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; LUX &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2006 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 30338.94 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 26668.19 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.138 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; MEX &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2004 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 8299895.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 7302821.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.137 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; SVK &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2006 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 50714.29 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 44744.18 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.133 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; NOR &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; B1GA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; VTOT &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2008 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2344746.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 2085049.00 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0.125 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

### Countries with maximum absolute growth rates


```r
sna_growth %&gt;% filter(LOCATION%in%sna_growth_top$LOCATION[1:8] &amp;
                      ACTIVITY == "VTOT" &amp; TRANSACT == "B1GA") %&gt;%
  ggplot(aes(x = date, y = growth, color = Measure)) +
  geom_line(size = 1) + facet_wrap( ~ LOCATION, ncol = 4) +
  theme(legend.position = "top", legend.direction = "horizontal")
```

![](11-dplyr-time-series/fig-html/sna_growth_plot-1.svg)&lt;!-- --&gt;

---
class: inverse, center, middle

# Introductory Time Series With R

## S P Cowpertwait, Paul &amp; Metcalfe, Andrew (2009)

10.1007/978-0-387-88698-5

---

## Basic Time Series Manipulation

- number of international passenger bookings (in thousands) per month on an
airline (Pan Am) in the United States
- Federal Aviation Administration, 1949–1960
- used to predict future demand before ordering new aircraft and training
  aircrew
- Brown, R. (1963). Smoothing, Forecasting, and Prediction of Discrete Time
Series. Englewood Cliffs, NJ: Prentice-Hall.


```r
data(AirPassengers)
AP &lt;- AirPassengers
head(AP)
```

```
## [1] 112 118 132 129 121 135
```

```r
class(AP)
```

```
## [1] "ts"
```

---

## Methods for `ts` objects


```r
start(AP); end(AP); frequency(AP); summary(AP)
```

```
## [1] 1949    1
```

```
## [1] 1960   12
```

```
## [1] 12
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   104.0   180.0   265.5   280.3   360.5   622.0
```

---

## Plotting `ts` objects


```r
par(mfrow = c(1, 2)); plot(AP, ylab = "Passengers (1000's)"); plot(aggregate(AP))
```

![](11-dplyr-time-series/fig-html/cw-example-5-1.svg)&lt;!-- --&gt;

---

## Aggregating `ts` objects

- trend analysis: remove seasonal effect  by aggregating to the annual level
- boxplot: summary of the values for each season
- `cycle` function being used to extract the seasons for each item of data


```r
par(mfrow = c(1, 2)); plot(aggregate(AP)); boxplot(AP ~ cycle(AP))
```

![](11-dplyr-time-series/fig-html/cw-example-7-1.svg)&lt;!-- --&gt;

---


```r
## www &lt;- "http://www.massey.ac.nz/~pscowper/ts/USunemp.dat"
www &lt;- "https://raw.githubusercontent.com/AtefOuni/ts/master/Data/USunemp.dat"
US.month &lt;- read.table(www, header = T)
attach(US.month)
US.month.ts &lt;- ts(USun, start=c(1996,1), end=c(2006,10), freq = 12)
plot(US.month.ts, ylab = "unemployed (%)")
```

![](11-dplyr-time-series/fig-html/cw-example-10-1-1.svg)&lt;!-- --&gt;

---


```
##   choc beer elec
## 1 1451 96.3 1497
## 2 2037 84.4 1463
## 3 2477 91.2 1648
## 4 2785 81.9 1595
```


```r
Elec.ts &lt;- ts(CBE[, 3], start = 1958, freq = 12)
Beer.ts &lt;- ts(CBE[, 2], start = 1958, freq = 12)
Choc.ts &lt;- ts(CBE[, 1], start = 1958, freq = 12)
plot(cbind(Elec.ts, Beer.ts, Choc.ts))
```

![](11-dplyr-time-series/fig-html/cw-example-10-3-1.svg)&lt;!-- --&gt;



---
class: inverse, center, middle

# Growth Rate Example: Quarterly Data

---

## Create Example Data


```r
date &lt;- c("2000-01-01","2000-04-01", "2000-07-01",
          "2000-10-01","2001-01-01","2001-04-01",
          "2001-07-01","2001-10-01","2002-01-01",
          "2002-04-01","2002-07-01","2002-10-01")
value &lt;- c(1592,1825,1769,1909,2022,2287,2169,2366,2001,2087,2099,2258)
df &lt;- data.frame(date,value)

## Convert date column to date format
df$date = as.POSIXct(df$date)
```


```
##         date value
## 1 2000-01-01  1592
## 2 2000-04-01  1825
## 3 2000-07-01  1769
## 4 2000-10-01  1909
## 5 2001-01-01  2022
## 6 2001-04-01  2287
```

---

## Growth Rate

Objective: calculate growth rate comparing quarter 1 from one year to quarter 1 for the following year


```r
df_q &lt;- df %&gt;% group_by(month=month(date)) %&gt;%
  arrange(date) %&gt;%
  mutate(yearOverYear=value/lag(value,1))
```


```
## # A tibble: 6 x 4
## # Groups:   month [4]
##         date value month yearOverYear
##       &lt;dttm&gt; &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;
## 1 2000-01-01  1592     1           NA
## 2 2000-04-01  1825     4           NA
## 3 2000-07-01  1769     7           NA
## 4 2000-10-01  1909    10           NA
## 5 2001-01-01  2022     1     1.270101
## 6 2001-04-01  2287     4     1.253151
```


```r
## value[2001-01-01] / value[2000-01-01]
2022 / 1592
```

```
## [1] 1.270101
```

---


```
## R version 3.4.2 (2017-09-28)
## Platform: x86_64-redhat-linux-gnu (64-bit)
## Running under: Fedora 27 (Workstation Edition)
## 
## Matrix products: default
## BLAS/LAPACK: /usr/lib64/R/lib/libRblas.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
## [1] bindrcpp_0.2    knitr_1.17      lubridate_1.6.0 tidyr_0.7.1    
## [5] dplyr_0.7.4     ggplot2_2.2.1   rmarkdown_1.6  
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_0.12.13     bindr_0.1        magrittr_1.5     munsell_0.4.3   
##  [5] colorspace_1.3-2 R6_2.2.2         rlang_0.1.2      highr_0.6       
##  [9] stringr_1.2.0    plyr_1.8.4       tools_3.4.2      grid_3.4.2      
## [13] gtable_0.2.0     xaringan_0.3     htmltools_0.3.6  yaml_2.1.14     
## [17] lazyeval_0.2.0   rprojroot_1.2    digest_0.6.12    assertthat_0.2.0
## [21] tibble_1.3.4     reshape2_1.4.2   purrr_0.2.3      glue_1.1.1      
## [25] evaluate_0.10.1  labeling_0.3     stringi_1.1.5    compiler_3.4.2  
## [29] scales_0.5.0     backports_1.1.0  pkgconfig_2.0.1
```
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {window.dispatchEvent(new Event('resize'));});</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
